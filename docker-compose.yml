services:
  certbot-init:
    image: ${REGISTRY_HOST}:${REGISTRY_PORT}/certbot/certbot:latest
    container_name: certbot-init
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./letsencrypt:/etc/letsencrypt
      - ./libletsencrypt:/var/lib/letsencrypt
    entrypoint: >
      /bin/sh -c '
      certbot certonly --standalone       --preferred-challenges http       --agree-tos       --no-eff-email       --email ${EMAIL}       -d ${DOMAIN}'

  keycloak:
    image: ${REGISTRY_HOST}:${REGISTRY_PORT}/quay.io/keycloak/keycloak:latest
    container_name: keycloak
    restart: always
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
    command:
      - start-dev
      - --https-port=8443
      - --https-certificate-file=/etc/letsencrypt/live/${DOMAIN}/fullchain.pem
      - --https-certificate-key-file=/etc/letsencrypt/live/${DOMAIN}/privkey.pem
    ports:
      - "8443:8443"
    volumes:
      - ./letsencrypt:/etc/letsencrypt

#自動更新
  certbot-renew:
    image: ${REGISTRY_HOST}:${REGISTRY_PORT}/certbot/certbot:latest
    container_name: certbot-renew
    volumes:
      - ./letsencrypt:/etc/letsencrypt
      - ./libletsencrypt:/var/lib/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
